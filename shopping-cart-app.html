<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Commerce & Shopping Cart Test App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .hidden {
        display: none;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        transform: translateY(20px);
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-success {
        background-color: #28a745;
      }
      .toast-error {
        background-color: #dc3545;
      }
      .toast-info {
        background-color: #17a2b8;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 50;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body class="antialiased text-gray-800">
    <!-- App Container -->
    <div class="container mx-auto p-4 max-w-7xl">
      <!-- Header & Navigation -->
      <header class="bg-white rounded-lg shadow-md p-4 mb-6">
        <nav class="flex justify-between items-center">
          <h1
            class="text-2xl font-bold text-gray-800 cursor-pointer"
            data-page="products"
          >
            ShopTest
          </h1>
          <div class="flex items-center space-x-4">
            <button
              data-page="products"
              class="text-gray-600 hover:text-blue-600"
            >
              Shop
            </button>
            <button
              data-page="cart"
              class="relative text-gray-600 hover:text-blue-600"
            >
              <span>Cart</span>
              <span
                id="cart-count"
                class="absolute -top-2 -right-3 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
                >0</span
              >
            </button>
            <button
              data-page="orders"
              class="text-gray-600 hover:text-blue-600 nav-user-only hidden"
            >
              My Orders
            </button>
            <div id="user-actions">
              <button
                data-page="account"
                id="account-btn"
                class="text-gray-600 hover:text-blue-600"
              >
                Login
              </button>
            </div>
            <button
              data-page="admin"
              class="text-gray-600 hover:text-blue-600 nav-admin-only hidden"
            >
              Admin
            </button>
          </div>
        </nav>
      </header>

      <!-- Main Content -->
      <main>
        <!-- Products Page -->
        <section id="products-page" class="page">
          <h2 class="text-3xl font-semibold mb-6">Products</h2>
          <div
            id="product-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
          >
            <!-- Product cards will be injected here by JS -->
          </div>
        </section>

        <!-- Cart Page -->
        <section id="cart-page" class="page hidden">
          <h2 class="text-3xl font-semibold mb-6">Your Shopping Cart</h2>
          <div
            id="cart-items-container"
            class="bg-white p-6 rounded-lg shadow-md"
          >
            <!-- Cart items will be injected here -->
          </div>
          <div id="cart-summary" class="mt-6">
            <!-- Cart summary will be injected here -->
          </div>
        </section>

        <!-- Account Page (Login/Register) -->
        <section id="account-page" class="page hidden">
          <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
            <div id="login-view">
              <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
              <form id="login-form">
                <div class="mb-4">
                  <label
                    for="login-email"
                    class="block text-sm font-medium text-gray-700"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="login-email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    required
                  />
                </div>
                <div class="mb-6">
                  <label
                    for="login-password"
                    class="block text-sm font-medium text-gray-700"
                    >Password</label
                  >
                  <input
                    type="password"
                    id="login-password"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    required
                  />
                </div>
                <button
                  type="submit"
                  class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                >
                  Login
                </button>
              </form>
              <p class="text-center mt-4">
                Don't have an account?
                <a
                  href="#"
                  id="show-register"
                  class="text-blue-600 hover:underline"
                  >Register</a
                >
              </p>
              <p class="text-center mt-2">
                <a
                  href="#"
                  id="password-reset-link"
                  class="text-sm text-gray-500 hover:underline"
                  >Forgot Password?</a
                >
              </p>
            </div>
            <div id="register-view" class="hidden">
              <h2 class="text-2xl font-bold text-center mb-6">Register</h2>
              <form id="register-form">
                <div class="mb-4">
                  <label
                    for="register-email"
                    class="block text-sm font-medium text-gray-700"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="register-email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                    required
                  />
                </div>
                <div class="mb-6">
                  <label
                    for="register-password"
                    class="block text-sm font-medium text-gray-700"
                    >Password</label
                  >
                  <input
                    type="password"
                    id="register-password"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
                    required
                  />
                </div>
                <button
                  type="submit"
                  class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
                >
                  Register
                </button>
              </form>
              <p class="text-center mt-4">
                Already have an account?
                <a
                  href="#"
                  id="show-login"
                  class="text-blue-600 hover:underline"
                  >Login</a
                >
              </p>
            </div>
          </div>
        </section>

        <!-- Checkout Page -->
        <section id="checkout-page" class="page hidden">
          <h2 class="text-3xl font-semibold mb-6">Checkout</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-2 bg-white p-8 rounded-lg shadow-md">
              <h3 class="text-xl font-medium mb-6">Shipping & Payment</h3>
              <form id="checkout-form">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700"
                    >Full Address</label
                  >
                  <input
                    type="text"
                    id="shipping-address"
                    class="mt-1 block w-full p-2 border rounded-md"
                    placeholder="123 Test Street, Testville"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700"
                    >Card Number</label
                  >
                  <input
                    type="text"
                    id="payment-card"
                    class="mt-1 block w-full p-2 border rounded-md"
                    placeholder="Enter 'valid' for success, anything else for failure"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700"
                    >Guest Checkout Email (if not logged in)</label
                  >
                  <input
                    type="email"
                    id="guest-email"
                    class="mt-1 block w-full p-2 border rounded-md"
                    placeholder="guest@example.com"
                  />
                </div>
              </form>
            </div>
            <div class="md:col-span-1 bg-white p-8 rounded-lg shadow-md">
              <h3 class="text-xl font-medium mb-4">Order Summary</h3>
              <div id="checkout-summary"></div>
              <div class="mt-4">
                <label class="block text-sm font-medium">Coupon Code</label>
                <div class="flex mt-1">
                  <input
                    type="text"
                    id="coupon-code"
                    class="w-full p-2 border rounded-l-md"
                    placeholder="DISCOUNT10"
                  />
                  <button
                    id="apply-coupon-btn"
                    class="bg-gray-600 text-white px-4 rounded-r-md hover:bg-gray-700"
                  >
                    Apply
                  </button>
                </div>
              </div>
              <button
                id="place-order-btn"
                class="w-full mt-6 bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 font-semibold"
              >
                Place Order
              </button>
            </div>
          </div>
        </section>

        <!-- Order Confirmation Page -->
        <section id="confirmation-page" class="page hidden text-center">
          <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-green-600 mb-4">
              Order Placed Successfully!
            </h2>
            <p class="text-gray-700 mb-2">Thank you for your purchase.</p>
            <p id="confirmation-details" class="text-gray-600"></p>
            <button
              data-page="products"
              class="mt-6 bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700"
            >
              Continue Shopping
            </button>
          </div>
        </section>

        <!-- My Orders Page -->
        <section id="orders-page" class="page hidden">
          <h2 class="text-3xl font-semibold mb-6">My Orders</h2>
          <div id="order-list" class="space-y-4">
            <!-- Orders will be injected here -->
          </div>
        </section>

        <!-- Admin Panel Page -->
        <section id="admin-page" class="page hidden">
          <h2 class="text-3xl font-semibold mb-6">
            Admin Panel - Product Management
          </h2>
          <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-medium mb-4" id="admin-form-title">
              Add New Product
            </h3>
            <form id="admin-product-form">
              <input type="hidden" id="product-id-input" />
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  type="text"
                  id="product-name"
                  placeholder="Product Name"
                  class="p-2 border rounded-md"
                  required
                />
                <input
                  type="number"
                  id="product-price"
                  placeholder="Price"
                  step="0.01"
                  min="0"
                  class="p-2 border rounded-md"
                  required
                />
                <input
                  type="number"
                  id="product-stock"
                  placeholder="Stock Quantity"
                  min="0"
                  class="p-2 border rounded-md"
                  required
                />
                <input
                  type="text"
                  id="product-image"
                  placeholder="Image URL"
                  class="p-2 border rounded-md col-span-1 md:col-span-2"
                  required
                />
              </div>
              <div class="flex space-x-2 mt-4">
                <button
                  type="submit"
                  id="admin-submit-btn"
                  class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                >
                  Add Product
                </button>
                <button
                  type="button"
                  id="admin-cancel-btn"
                  class="bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500 hidden"
                >
                  Cancel Edit
                </button>
              </div>
            </form>
          </div>
          <div
            id="admin-product-list"
            class="bg-white p-6 rounded-lg shadow-md"
          >
            <h3 class="text-xl font-medium mb-4">Existing Products</h3>
            <!-- Admin product list will be injected here -->
          </div>
        </section>
      </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- DATA STORE & STATE MANAGEMENT ---

        // Central state object
        let state = {
          products: [],
          cart: [], // { productId: string, quantity: number }
          users: [], // { email: string, password: string, role: 'user' | 'admin' }
          orders: [], // Complex order object
          currentUser: null, // email of logged-in user
          couponApplied: false,
        };

        const initialProducts = [
          // Test Case: CART_TC_01, CART_TC_04
          {
            id: "p1",
            name: "Plush Toy Dragon",
            price: 19.99,
            stock: 50,
            imageUrl: "https://placehold.co/400x400/7c3aed/ffffff?text=Dragon",
          },
          // Test Case: CART_TC_09
          {
            id: "p2",
            name: "Limited Edition Console",
            price: 499.99,
            stock: 5,
            imageUrl: "https://placehold.co/400x400/f59e0b/ffffff?text=Console",
          },
          // Test Case: CART_TC_02, CO_TC_03
          {
            id: "p3",
            name: "Collector's Artbook",
            price: 89.99,
            stock: 0,
            imageUrl: "https://placehold.co/400x400/ef4444/ffffff?text=Artbook",
          },
          {
            id: "p4",
            name: "Gaming Mouse",
            price: 59.99,
            stock: 120,
            imageUrl: "https://placehold.co/400x400/22c55e/ffffff?text=Mouse",
          },
        ];

        const initialUsers = [
          { email: "user@test.com", password: "password", role: "user" },
          { email: "admin@test.com", password: "adminpass", role: "admin" },
        ];

        // --- UI ELEMENT SELECTORS ---
        const pages = document.querySelectorAll(".page");
        const productListEl = document.getElementById("product-list");
        const cartCountEl = document.getElementById("cart-count");
        const cartItemsContainerEl = document.getElementById(
          "cart-items-container"
        );
        const cartSummaryEl = document.getElementById("cart-summary");
        const checkoutSummaryEl = document.getElementById("checkout-summary");

        // --- INITIALIZATION ---
        function initializeApp() {
          // Load data from localStorage or set initial data
          state.products =
            JSON.parse(localStorage.getItem("products")) || initialProducts;
          state.cart = JSON.parse(localStorage.getItem("cart")) || [];
          state.users =
            JSON.parse(localStorage.getItem("users")) || initialUsers;
          state.orders = JSON.parse(localStorage.getItem("orders")) || [];
          state.currentUser =
            JSON.parse(sessionStorage.getItem("currentUser")) || null;

          // Save initial data if it's the first run
          if (!localStorage.getItem("products")) saveDataToLocalStorage();

          // Add event listeners
          setupEventListeners();

          // Initial Render
          renderAll();
        }

        // --- DATA PERSISTENCE ---
        function saveDataToLocalStorage() {
          localStorage.setItem("products", JSON.stringify(state.products));
          localStorage.setItem("cart", JSON.stringify(state.cart));
          localStorage.setItem("users", JSON.stringify(state.users));
          localStorage.setItem("orders", JSON.stringify(state.orders));
        }

        function saveSessionData() {
          sessionStorage.setItem(
            "currentUser",
            JSON.stringify(state.currentUser)
          );
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
          renderProducts();
          renderCart();
          updateCartCount();
          updateUserUI();
          renderAdminProducts();
          renderOrders();
        }

        function renderProducts() {
          productListEl.innerHTML = "";
          state.products.forEach((product) => {
            const stockStatus =
              product.stock > 0
                ? `In Stock (${product.stock})`
                : "Out of Stock";
            const stockColor =
              product.stock > 0 ? "text-green-600" : "text-red-600";
            const disabled = product.stock === 0 ? "disabled" : "";

            productListEl.innerHTML += `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
                            <img src="${product.imageUrl}" alt="${
              product.name
            }" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="text-lg font-semibold">${
                                  product.name
                                }</h3>
                                <p class="text-gray-600 mt-1">$${product.price.toFixed(
                                  2
                                )}</p>
                                <p class="text-sm font-medium mt-2 ${stockColor}">${stockStatus}</p>
                                <div class="mt-4 flex items-center">
                                    <input type="number" value="1" min="1" max="${
                                      product.stock
                                    }" class="w-16 p-2 border rounded-md mr-2" data-product-id="${
              product.id
            }" ${disabled}>
                                    <button data-product-id="${
                                      product.id
                                    }" class="add-to-cart-btn flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 ${
              disabled ? "bg-gray-400 cursor-not-allowed" : ""
            }" ${disabled}>
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
          });
        }

        function renderCart() {
          if (state.cart.length === 0) {
            cartItemsContainerEl.innerHTML =
              '<p class="text-gray-500">Your cart is empty.</p>';
            cartSummaryEl.innerHTML = "";
            return;
          }

          let itemsHtml = "";
          state.cart.forEach((item) => {
            const product = getProductById(item.productId);
            if (!product) return;
            itemsHtml += `
                        <div class="flex items-center justify-between border-b py-4">
                            <div class="flex items-center">
                                <img src="${product.imageUrl}" alt="${
              product.name
            }" class="w-16 h-16 object-cover rounded-md mr-4">
                                <div>
                                    <p class="font-semibold">${product.name}</p>
                                    <p class="text-sm text-gray-500">$${product.price.toFixed(
                                      2
                                    )}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="number" value="${
                                  item.quantity
                                }" min="1" max="${
              product.stock
            }" data-product-id="${
              product.id
            }" class="update-quantity-input w-16 p-2 border rounded-md mr-4 text-center">
                                <p class="font-semibold w-24 text-right mr-4">$${(
                                  item.quantity * product.price
                                ).toFixed(2)}</p>
                                <button data-product-id="${
                                  product.id
                                }" class="remove-from-cart-btn text-red-500 hover:text-red-700 font-bold">X</button>
                            </div>
                        </div>
                    `;
          });
          cartItemsContainerEl.innerHTML = itemsHtml;

          renderCartSummary();
        }

        function renderCartSummary() {
          if (state.cart.length === 0) {
            cartSummaryEl.innerHTML = "";
            checkoutSummaryEl.innerHTML = "";
            return;
          }

          const subtotal = state.cart.reduce((sum, item) => {
            const product = getProductById(item.productId);
            return sum + (product ? product.price * item.quantity : 0);
          }, 0);

          let discount = 0;
          if (state.couponApplied) {
            discount = subtotal * 0.1; // 10% discount
          }

          const total = subtotal - discount;

          const summaryHtml = `
                    <div class="max-w-sm ml-auto bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between mb-2">
                            <span>Subtotal:</span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                        <div id="discount-row" class="flex justify-between mb-2 text-green-600 ${
                          discount > 0 ? "" : "hidden"
                        }">
                            <span>Discount (10%):</span>
                            <span>-$${discount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg border-t pt-2">
                            <span>Total:</span>
                            <span>$${total.toFixed(2)}</span>
                        </div>
                         <div class="flex space-x-2 mt-6">
                            <button id="checkout-btn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Checkout</button>
                            <button id="empty-cart-btn" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Empty Cart</button>
                        </div>
                    </div>
                `;
          cartSummaryEl.innerHTML = summaryHtml;

          // Also update checkout summary
          const checkoutSummaryHtml = `
                     <div class="flex justify-between mb-2">
                        <span>Subtotal:</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div id="checkout-discount-row" class="flex justify-between mb-2 text-green-600 ${
                      discount > 0 ? "" : "hidden"
                    }">
                        <span>Discount (10%):</span>
                        <span>-$${discount.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg border-t pt-2">
                        <span>Total:</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                `;
          checkoutSummaryEl.innerHTML = checkoutSummaryHtml;
        }

        function updateCartCount() {
          const totalItems = state.cart.reduce(
            (sum, item) => sum + item.quantity,
            0
          );
          cartCountEl.textContent = totalItems;
        }

        function updateUserUI() {
          const userActionsEl = document.getElementById("user-actions");
          const accountBtn = document.getElementById("account-btn");
          const navUserOnly = document.querySelectorAll(".nav-user-only");
          const navAdminOnly = document.querySelectorAll(".nav-admin-only");

          if (state.currentUser) {
            const user = getUserByEmail(state.currentUser);
            accountBtn.textContent = "Logout";
            userActionsEl.innerHTML = `<span class="text-sm font-medium mr-2">${state.currentUser}</span> <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Logout</button>`;
            navUserOnly.forEach((el) => el.classList.remove("hidden"));

            if (user && user.role === "admin") {
              navAdminOnly.forEach((el) => el.classList.remove("hidden"));
            } else {
              navAdminOnly.forEach((el) => el.classList.add("hidden"));
            }
          } else {
            userActionsEl.innerHTML = `<button data-page="account" class="text-gray-600 hover:text-blue-600">Login</button>`;
            navUserOnly.forEach((el) => el.classList.add("hidden"));
            navAdminOnly.forEach((el) => el.classList.add("hidden"));
          }
        }

        function renderAdminProducts() {
          const listEl = document.getElementById("admin-product-list");
          listEl.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left">Name</th>
                                    <th class="py-2 px-4 border-b text-left">Price</th>
                                    <th class="py-2 px-4 border-b text-left">Stock</th>
                                    <th class="py-2 px-4 border-b text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.products
                                  .map(
                                    (p) => `
                                    <tr>
                                        <td class="py-2 px-4 border-b">${
                                          p.name
                                        }</td>
                                        <td class="py-2 px-4 border-b">$${p.price.toFixed(
                                          2
                                        )}</td>
                                        <td class="py-2 px-4 border-b">${
                                          p.stock
                                        }</td>
                                        <td class="py-2 px-4 border-b">
                                            <button data-product-id="${
                                              p.id
                                            }" class="edit-product-btn text-blue-500 hover:underline mr-2">Edit</button>
                                            <button data-product-id="${
                                              p.id
                                            }" class="delete-product-btn text-red-500 hover:underline">Delete</button>
                                        </td>
                                    </tr>
                                `
                                  )
                                  .join("")}
                            </tbody>
                        </table>
                    </div>
                `;
        }

        function renderOrders() {
          const orderListEl = document.getElementById("order-list");
          if (!state.currentUser) {
            orderListEl.innerHTML = "<p>Please log in to see your orders.</p>";
            return;
          }
          const userOrders = state.orders.filter(
            (o) => o.userEmail === state.currentUser
          );

          if (userOrders.length === 0) {
            orderListEl.innerHTML = "<p>You have no orders yet.</p>";
            return;
          }
          orderListEl.innerHTML = userOrders
            .map(
              (order) => `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="font-bold">Order #${order.id.slice(
                                  0,
                                  8
                                )}</p>
                                <p class="text-sm text-gray-500">Placed on: ${new Date(
                                  order.date
                                ).toLocaleDateString()}</p>
                           </div>
                           <div class="text-right">
                               <p class="font-semibold text-lg">$${order.total.toFixed(
                                 2
                               )}</p>
                               <p class="text-sm font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-800">${
                                 order.status
                               }</p>
                           </div>
                        </div>
                        <div class="mt-4 border-t pt-2">
                             ${order.items
                               .map(
                                 (item) =>
                                   `<p class="text-sm">${item.name} (x${item.quantity})</p>`
                               )
                               .join("")}
                        </div>
                        <div class="mt-4 flex space-x-2">
                            ${
                              order.status === "Placed"
                                ? `<button data-order-id="${order.id}" class="cancel-order-btn bg-yellow-500 text-white text-sm px-3 py-1 rounded-md">Cancel (Before Payment)</button>`
                                : ""
                            }
                            ${
                              order.status === "Paid"
                                ? `<button data-order-id="${order.id}" class="cancel-order-btn bg-yellow-500 text-white text-sm px-3 py-1 rounded-md">Cancel (After Payment)</button>`
                                : ""
                            }
                            ${
                              order.status === "Delivered"
                                ? `<button data-order-id="${order.id}" class="return-order-btn bg-orange-500 text-white text-sm px-3 py-1 rounded-md">Return Order</button>`
                                : ""
                            }
                            ${
                              order.status === "Paid"
                                ? `<button data-order-id="${order.id}" class="update-status-btn" data-status="Shipped">Simulate Ship</button>`
                                : ""
                            }
                            ${
                              order.status === "Shipped"
                                ? `<button data-order-id="${order.id}" class="update-status-btn" data-status="Delivered">Simulate Deliver</button>`
                                : ""
                            }
                        </div>
                    </div>
                `
            )
            .join("");
        }

        // --- CORE LOGIC & EVENT HANDLERS ---

        function setupEventListeners() {
          // Navigation
          document.body.addEventListener("click", (e) => {
            const pageButton = e.target.closest("[data-page]");
            if (pageButton) {
              showPage(pageButton.dataset.page);
            }
          });

          // Products Page
          productListEl.addEventListener("click", (e) => {
            if (e.target.classList.contains("add-to-cart-btn")) {
              const productId = e.target.dataset.productId;
              const quantityInput = productListEl.querySelector(
                `input[data-product-id="${productId}"]`
              );
              const quantity = parseInt(quantityInput.value, 10);
              addToCart(productId, quantity);
            }
          });

          // Cart Page
          cartItemsContainerEl.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-from-cart-btn")) {
              removeFromCart(e.target.dataset.productId);
            }
          });
          cartItemsContainerEl.addEventListener("change", (e) => {
            if (e.target.classList.contains("update-quantity-input")) {
              const newQuantity = parseInt(e.target.value, 10);
              updateCartQuantity(e.target.dataset.productId, newQuantity);
            }
          });
          cartSummaryEl.addEventListener("click", (e) => {
            if (e.target.id === "empty-cart-btn") {
              emptyCart(); // Test Case: CART_TC_07
            }
            if (e.target.id === "checkout-btn") {
              showPage("checkout");
            }
          });

          // Account Page
          document
            .getElementById("show-register")
            .addEventListener("click", () => toggleAuthView(true));
          document
            .getElementById("show-login")
            .addEventListener("click", () => toggleAuthView(false));
          document
            .getElementById("login-form")
            .addEventListener("submit", handleLogin);
          document
            .getElementById("register-form")
            .addEventListener("submit", handleRegister);
          document
            .getElementById("password-reset-link")
            .addEventListener("click", () => {
              // Test Case: USR_TC_05
              showToast("Password reset email sent (simulation).", "info");
            });
          document.body.addEventListener("click", (e) => {
            if (e.target.id === "logout-btn") {
              handleLogout();
            }
          });

          // Checkout Page
          document
            .getElementById("apply-coupon-btn")
            .addEventListener("click", applyCoupon);
          document
            .getElementById("place-order-btn")
            .addEventListener("click", handlePlaceOrder);

          // Admin Page
          document
            .getElementById("admin-product-form")
            .addEventListener("submit", handleAdminFormSubmit);
          document
            .getElementById("admin-cancel-btn")
            .addEventListener("click", resetAdminForm);
          document
            .getElementById("admin-product-list")
            .addEventListener("click", (e) => {
              const productId = e.target.dataset.productId;
              if (e.target.classList.contains("edit-product-btn")) {
                editProduct(productId);
              }
              if (e.target.classList.contains("delete-product-btn")) {
                deleteProduct(productId);
              }
            });

          // Orders page
          document
            .getElementById("order-list")
            .addEventListener("click", (e) => {
              const orderId = e.target.dataset.orderId;
              if (!orderId) return;

              if (e.target.classList.contains("cancel-order-btn")) {
                cancelOrder(orderId);
              }
              if (e.target.classList.contains("return-order-btn")) {
                returnOrder(orderId);
              }
              if (e.target.classList.contains("update-status-btn")) {
                // Test Case: ORD_TC_01
                const newStatus = e.target.dataset.status;
                const order = getOrderById(orderId);
                if (order) {
                  order.status = newStatus;
                  if (newStatus === "Shipped") order.status = "Paid"; // To test transitions
                  if (newStatus === "Delivered") order.status = "Shipped";
                  order.status = newStatus;
                  showToast(`Order status updated to ${newStatus}.`, "info");
                  saveAndRender();
                }
              }
            });
        }

        function addToCart(productId, quantity) {
          // Test Case: CART_TC_03
          if (quantity <= 0) {
            showToast("Quantity must be greater than 0.", "error");
            return;
          }

          const product = getProductById(productId);
          if (!product) {
            showToast("Product not found.", "error");
            return;
          }

          // Test Case: CART_TC_02
          if (product.stock === 0) {
            showToast("This item is out of stock.", "error");
            return;
          }

          const existingItem = state.cart.find(
            (item) => item.productId === productId
          );
          const quantityInCart = existingItem ? existingItem.quantity : 0;

          // Test Case: CART_TC_09
          if (quantity + quantityInCart > product.stock) {
            showToast(
              `Cannot add more. Only ${product.stock} available in stock.`,
              "error"
            );
            return;
          }

          if (existingItem) {
            // Test Case: CART_TC_04
            existingItem.quantity += quantity;
          } else {
            // Test Case: CART_TC_01
            state.cart.push({ productId, quantity });
          }

          showToast(`${product.name} added to cart.`, "success");
          saveAndRender();
        }

        function removeFromCart(productId) {
          // Test Case: CART_TC_05
          state.cart = state.cart.filter(
            (item) => item.productId !== productId
          );
          showToast("Item removed from cart.", "info");
          saveAndRender();
        }

        function updateCartQuantity(productId, newQuantity) {
          // Test Case: CART_TC_06
          if (newQuantity <= 0) {
            removeFromCart(productId);
            return;
          }

          const product = getProductById(productId);
          if (newQuantity > product.stock) {
            showToast(
              `Only ${product.stock} available. Quantity adjusted.`,
              "error"
            );
            newQuantity = product.stock;
          }

          const cartItem = state.cart.find(
            (item) => item.productId === productId
          );
          if (cartItem) {
            cartItem.quantity = newQuantity;
          }

          saveAndRender();
        }

        function emptyCart() {
          state.cart = [];
          state.couponApplied = false;
          showToast("Cart has been emptied.", "info");
          saveAndRender();
        }

        function handleLogin(e) {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-password").value;
          const user = getUserByEmail(email);

          if (user && user.password === password) {
            // Test Case: USR_TC_03
            state.currentUser = email;
            showToast("Login successful!", "success");
            showPage("products");
          } else {
            // Test Case: USR_TC_04
            showToast("Invalid credentials.", "error");
          }
          saveSessionData();
          updateUserUI();
          renderOrders();
        }

        function handleLogout() {
          // Test Case: CART_TC_08 (Part 1: logout)
          state.currentUser = null;
          showToast("Logged out successfully.", "info");
          sessionStorage.removeItem("currentUser");
          showPage("products");
          updateUserUI();
          renderOrders();
        }

        function handleRegister(e) {
          e.preventDefault();
          const email = document.getElementById("register-email").value;
          const password = document.getElementById("register-password").value;

          if (getUserByEmail(email)) {
            // Test Case: USR_TC_02
            showToast("An account with this email already exists.", "error");
          } else {
            // Test Case: USR_TC_01
            state.users.push({ email, password, role: "user" });
            showToast("Registration successful! Please log in.", "success");
            toggleAuthView(false); // Switch to login view
            saveDataToLocalStorage();
          }
        }

        function applyCoupon() {
          const code = document
            .getElementById("coupon-code")
            .value.trim()
            .toUpperCase();
          if (code === "DISCOUNT10") {
            // Test Case: CO_TC_06
            state.couponApplied = true;
            showToast("Coupon applied successfully!", "success");
          } else if (code === "EXPIRED") {
            // Test Case: CO_TC_07
            state.couponApplied = false;
            showToast("This coupon is expired.", "error");
          } else {
            // Test Case: CO_TC_07
            state.couponApplied = false;
            showToast("Invalid coupon code.", "error");
          }
          renderCartSummary();
        }

        function handlePlaceOrder() {
          // Test Case: CO_TC_04
          if (state.cart.length === 0) {
            showToast("Cannot checkout with an empty cart.", "error");
            return;
          }

          // Check for out-of-stock items
          for (const item of state.cart) {
            const product = getProductById(item.productId);
            if (product.stock < item.quantity) {
              // Test Case: CO_TC_03
              showToast(
                `Item '${product.name}' is out of stock. Please remove it to proceed.`,
                "error"
              );
              return;
            }
          }

          const address = document.getElementById("shipping-address").value;
          // Test Case: CO_TC_08
          if (address.trim().length < 5) {
            showToast("Please enter a valid shipping address.", "error");
            return;
          }

          const payment = document.getElementById("payment-card").value;
          // Test Case: CO_TC_02
          if (payment.toLowerCase() !== "valid") {
            showToast("Payment failed. Please try again.", "error");
            return;
          }

          let userEmail = state.currentUser;
          // Test Case: CO_TC_05
          if (!userEmail) {
            userEmail = document.getElementById("guest-email").value;
            if (!userEmail || !userEmail.includes("@")) {
              showToast(
                "Please enter a valid email for guest checkout.",
                "error"
              );
              return;
            }
          }

          // Test Case: CO_TC_01
          const subtotal = state.cart.reduce(
            (sum, item) =>
              sum + getProductById(item.productId).price * item.quantity,
            0
          );
          const discount = state.couponApplied ? subtotal * 0.1 : 0;
          const total = subtotal - discount;

          const newOrder = {
            id: "ord" + Date.now(),
            userEmail: userEmail,
            date: new Date().toISOString(),
            items: state.cart.map((i) => ({
              ...getProductById(i.productId),
              quantity: i.quantity,
            })),
            total: total,
            status: "Paid", // Test Case: ORD_TC_01
          };

          // Update stock levels
          state.cart.forEach((item) => {
            const product = getProductById(item.productId);
            product.stock -= item.quantity;
          });

          state.orders.push(newOrder);
          emptyCart(); // Clears cart after order

          document.getElementById(
            "confirmation-details"
          ).textContent = `Your Order ID is ${newOrder.id.slice(
            0,
            8
          )}. Total: $${newOrder.total.toFixed(2)}`;
          showPage("confirmation");
          saveAndRender();
        }

        function cancelOrder(orderId) {
          const order = getOrderById(orderId);
          if (!order) return;

          if (order.status === "Placed") {
            // Test Case: ORD_TC_02
            order.status = "Cancelled";
            showToast("Order cancelled.", "info");
          } else if (order.status === "Paid" || order.status === "Shipped") {
            // Test Case: ORD_TC_03
            order.status = "Cancelled";
            showToast(
              "Order cancelled. Refund will be issued (simulation).",
              "info"
            );
          }
          saveAndRender();
        }

        function returnOrder(orderId) {
          const order = getOrderById(orderId);
          if (order && order.status === "Delivered") {
            // Test Case: ORD_TC_04
            order.status = "Returned";
            showToast(
              "Return initiated. Refund will be processed (simulation).",
              "info"
            );
            saveAndRender();
          }
        }

        // --- ADMIN FUNCTIONS ---
        function handleAdminFormSubmit(e) {
          e.preventDefault();
          const id = document.getElementById("product-id-input").value;
          const name = document.getElementById("product-name").value.trim();
          const price = parseFloat(
            document.getElementById("product-price").value
          );
          const stock = parseInt(
            document.getElementById("product-stock").value,
            10
          );
          const imageUrl = document
            .getElementById("product-image")
            .value.trim();

          if (!name || isNaN(price) || isNaN(stock) || !imageUrl) {
            // Test Case: ADM_TC_04
            showToast("All fields are required.", "error");
            return;
          }

          if (id) {
            // Test Case: ADM_TC_02
            const product = getProductById(id);
            if (product) {
              product.name = name;
              product.price = price;
              product.stock = stock;
              product.imageUrl = imageUrl;
              showToast("Product updated successfully.", "success");
            }
          } else {
            // Test Case: ADM_TC_01
            const newProduct = {
              id: "p" + (state.products.length + 1) + Date.now(),
              name,
              price,
              stock,
              imageUrl,
            };
            state.products.push(newProduct);
            showToast("Product added successfully.", "success");
          }
          resetAdminForm();
          saveAndRender();
        }

        function editProduct(productId) {
          const product = getProductById(productId);
          if (!product) return;

          document.getElementById("admin-form-title").textContent =
            "Edit Product";
          document.getElementById("product-id-input").value = product.id;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-price").value = product.price;
          document.getElementById("product-stock").value = product.stock;
          document.getElementById("product-image").value = product.imageUrl;
          document.getElementById("admin-submit-btn").textContent =
            "Update Product";
          document
            .getElementById("admin-cancel-btn")
            .classList.remove("hidden");
          window.scrollTo(0, 0);
        }

        function deleteProduct(productId) {
          // Test Case: ADM_TC_03
          state.products = state.products.filter((p) => p.id !== productId);
          // Also remove from any carts
          state.cart = state.cart.filter(
            (item) => item.productId !== productId
          );
          showToast("Product deleted.", "info");
          saveAndRender();
        }

        function resetAdminForm() {
          document.getElementById("admin-product-form").reset();
          document.getElementById("admin-form-title").textContent =
            "Add New Product";
          document.getElementById("product-id-input").value = "";
          document.getElementById("admin-submit-btn").textContent =
            "Add Product";
          document.getElementById("admin-cancel-btn").classList.add("hidden");
        }

        // --- UTILITY FUNCTIONS ---
        function saveAndRender() {
          saveDataToLocalStorage();
          renderAll();
        }

        function showPage(pageId) {
          pages.forEach((page) => page.classList.add("hidden"));
          const activePage = document.getElementById(`${pageId}-page`);
          if (activePage) activePage.classList.remove("hidden");
        }

        function showToast(message, type = "info") {
          const toast = document.getElementById("toast-notification");
          toast.textContent = message;
          toast.className = "toast"; // Reset classes
          toast.classList.add(`toast-${type}`);
          toast.classList.add("show");

          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }

        function getProductById(id) {
          return state.products.find((p) => p.id === id);
        }

        function getUserByEmail(email) {
          return state.users.find((u) => u.email === email);
        }

        function getOrderById(id) {
          return state.orders.find((o) => o.id === id);
        }

        function toggleAuthView(showRegister) {
          document
            .getElementById("login-view")
            .classList.toggle("hidden", showRegister);
          document
            .getElementById("register-view")
            .classList.toggle("hidden", !showRegister);
        }

        // --- START THE APP ---
        initializeApp();
      });
    </script>
  </body>
</html>
